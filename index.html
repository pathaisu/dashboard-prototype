<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Average Score by Scenario</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      body {
        font-family: 'Inter', sans-serif;
      }
      .header {
        background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%);
        padding: 2rem;
        border-radius: 12px;
        color: white;
        text-align: center;
        margin-bottom: 2rem;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      }
      .header h1 {
        font-size: 2.5rem;
        font-weight: bold;
      }
      .header p {
        font-size: 1.2rem;
        margin-top: 0.5rem;
        color: #dbeafe;
      }
      .card {
        background-color: white;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        padding: 24px;
        margin-bottom: 24px;
      }
      .chart-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #374151;
        margin-bottom: 12px;
      }
      #scenario-selection {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        max-height: 150px;
        overflow-y: auto;
        padding: 8px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background-color: #f9fafb;
      }

      .scenario-checkbox {
        display: flex;
        align-items: center;
        white-space: nowrap;
        font-size: 14px;
        padding: 4px 8px;
        background-color: #ffffff;
        border: 1px solid #d1d5db;
        border-radius: 4px;
      }

      .scenario-checkbox input[type="checkbox"] {
        margin-right: 6px;
      }
    </style>
</head>
<body class="bg-gray-50 p-8">
    <!-- Class Average Score Chart -->
    <div class="container mx-auto max-w-5xl" id="chart-container">
      <!-- Header -->
      <header class="header">
        <h1>Nurse Student Performance Dashboard</h1>
        <p>Analyze and Improve Student Performance in Practical Scenarios</p>
      </header>

      <!-- Optional Toggle UI for Scenarios -->
      <div class="card mb-4">
        <h2 class="chart-title text-gray-700 mb-2">Filter Scenarios</h2>
        <div id="scenario-selection">
          <!-- Dynamically generated checkboxes for scenarios will go here -->
        </div>
      </div>

      <div class="card">
        <h2 class="chart-title text-gray-700">Score Distribution Histogram (Select Scenarios)</h2>
        <!-- <div id="scenario-selection" class="flex space-x-4 mb-4">
]        </div> -->
        <canvas id="scoreDistributionHistogramByScenarios" width="400" height="200"></canvas>
      </div>
    </div>
    
    <script>
      // The function to generate the mock class data (from the previous step)
      function generateStudentScore(studentId) {
        const randomScore = () => Math.floor(Math.random() * 101);  // Score between 0 and 100
        const randomTime = () => (Math.random() * 5 + 5).toFixed(2);

        const scenarios = [
          { "Scenario": "การเตรียมตัวผู้ทำคลอด 2/2", "Page": "P10/S.6", "Scene": "สวมถุงมือให้มิดปลายแขนเสื้อสีขาว" },
          { "Scenario": "การเตรียมอุปกรณ์ทำคลอด", "Page": "P12/S.1", "Scene": "เลือกอุปกรณ์และนำมาวาง" },
          { "Scenario": "การเตรียมอุปกรณ์ทำคลอด", "Page": "P12/S.2", "Scene": "1. Sponge forceps" },
          { "Scenario": "การเตรียมอุปกรณ์ทำคลอด", "Page": "P12/S.3", "Scene": "2. Episiotomy scissors" },
          { "Scenario": "การเตรียมอุปกรณ์ทำคลอด", "Page": "P12/S.4", "Scene": "3. Cord Clamp" },
          { "Scenario": "การเตรียมอุปกรณ์ทำคลอด", "Page": "P12/S.5", "Scene": "4. Artery Clamp" },
          { "Scenario": "การเตรียมอุปกรณ์ทำคลอด", "Page": "P12/S.6", "Scene": "5. Umbilical scissors" },
          { "Scenario": "การเตรียมตัวผู้คลอด 1/3", "Page": "P14/S.2", "Scene": "โกรกน้ำผู้คลอดรอบที่ 1" },
          { "Scenario": "การเตรียมตัวผู้คลอด 1/3", "Page": "P14/S.3", "Scene": "ทำ Scrub Vulva ถูกต้อง" },
          { "Scenario": "การเตรียมตัวผู้คลอด 1/3", "Page": "P14/S.4", "Scene": "ทำ Scrub Vulva เสร็จทิ้งสำลีลงถังขยะ" },
          { "Scenario": "การเตรียมตัวผู้คลอด 2/3", "Page": "P15/S.1", "Scene": "ใช้ Sponge forceps เสร็จให้หนีบที่ชายผ้า" },
          { "Scenario": "การเตรียมตัวผู้คลอด 2/3", "Page": "P15/S.2", "Scene": "โกรกน้ำรอบ 2 เสร็จนำสำลีไปไว้อ่างเดิม" },
          { "Scenario": "การเตรียมตัวผู้คลอด 2/3", "Page": "P15/S.3", "Scene": "ปูผ้าผู้คลอด ชิ้นที่ 1 รองใต้ก้น" },
          { "Scenario": "การเตรียมตัวผู้คลอด 2/3", "Page": "P15/S.4", "Scene": "ปูผ้าผู้คลอด ชิ้นที่ 2 บนหน้าท้อง" },
          { "Scenario": "การเตรียมตัวผู้คลอด 3/3", "Page": "P16/S.1", "Scene": "ปูผ้าผู้คลอด ชิ้นที่ 3 สวมขา ข้างใดก่อนก็ได้" },
          { "Scenario": "การทำคลอดทารก 1/4", "Page": "P18/S.1", "Scene": "การตัดฝีเย็บ เฉียงไปทางขวาของผู้คลอด" },
          { "Scenario": "การทำคลอดทารก 1/4", "Page": "P18/S.2", "Scene": "ทำ Safe perineum ไม่ให้ฝีเย็บฉีกพิ่ม" },
          { "Scenario": "การทำคลอดทารก 2/4", "Page": "P19/S.1", "Scene": "ดูดเสมหะให้ทารกทางปากและจมูก" },
          { "Scenario": "การทำคลอดทารก 3/4", "Page": "P20/S.1", "Scene": "ทำการคลอดไหล่ล่างในท่าที่ถูกต้อง" },
          { "Scenario": "การทำคลอดทารก 4/4", "Page": "P22/S.1", "Scene": "คลอดเสร็จดูดเสมหะทารก ปากและจมูก" },
          { "Scenario": "การทำคลอดรก 1/2", "Page": "P25/S.1", "Scene": "นำถุงรองเลือดไปรองใต้ก้นผู้คลอด" },
          { "Scenario": "การทำคลอดรก 1/2", "Page": "P25/S.2", "Scene": "ทำ Uterine sign เปิดผ้าบนหน้าท้อง" },
          { "Scenario": "การทำคลอดรก 1/2", "Page": "P25/S.3", "Scene": "ทำ Cord sign และคลำชีพจรด้วยนิ้วชี้และนิ้วกลาง" },
          { "Scenario": "การทำคลอดรก 1/2", "Page": "P25/S.4", "Scene": "ทำ Vulva sign ต้องรอจนกว่ําเลือดจะหยุดไหล" },
          { "Scenario": "การทำคลอดรก 2/2", "Page": "P26/S.1", "Scene": "กดหน้าท้องต่อเนื่อง จนขั้วรกเริ่มออกมา" },
          { "Scenario": "การทำคลอดรก 2/2", "Page": "P26/S.2", "Scene": "กดหน้าท้องต่อเนื่อง จนรกเคลื่อนออกมา" },
          { "Scenario": "ผู้ช่วยฉีดยาเร่งคลอด", "Page": "P30/S.3", "Scene": "ฉีดยาถูกต้อง เลือกปริมาณยาถูกต้อง" },
          { "Scenario": "ผู้ช่วยฉีดยาเร่งคลอด", "Page": "P31/S.3", "Scene": "ฉีดยาถูกต้อง เลือกปริมาณยาถูกต้อง" },
          { "Scenario": "Scenario ที่ 1", "Page": "-", "Scene": "มารดาครรภ์แรก อายุ 26 ปี อายุครรภ์ 40 สัปดาห์" },
          { "Scenario": "Scenario ที่ 2", "Page": "-", "Scene": "มารดา G2P1 อายุ 30 ปี อายุครรภ์ 39 สัปดาห์" }
        ];

        return {
          "Metadata": {
              "StudentID": studentId,
              "Latest_Date": "2024-04-05",
              "Latest_Time": "15:10:44",
              "Class": "A",
              "Academic_Year": "2024",
              "Subject": "ทำคลอด"
          },
          "Data": scenarios.map(scenario => ({
              "Scenario": scenario.Scenario,
              "Page": scenario.Page,
              "Scene": scenario.Scene,
              "Score_Conditions": "ปฏิบัติตามลำดับ",
              "Earned_Score": randomScore(),
              "Penalty_Conditions": "ไม่ปฏิบัติตามลำดับ",
              "Deducted_Score": 10, // Example penalty score
              "Total_Score": Math.max(0, randomScore() - 10),
              "Completion_Time": randomTime() // Time taken to complete the scenario
          }))
        };
      }

      // Function to generate 20 students
      function generateClassData(numberOfStudents) {
        const classData = [];
        for (let i = 1; i <= numberOfStudents; i++) {
            const studentId = `T 651016${i}`;
            classData.push(generateStudentScore(studentId));
        }
        return classData;
      }

      const studentsData = generateClassData(40);

      const scenarioNames = studentsData[0].Data.map(d => d.Scenario);
      const averageScores = scenarioNames.map((_, index) => {
          const totalScore = studentsData.reduce((sum, student) => sum + student.Data[index].Earned_Score, 0);
          return totalScore / studentsData.length;
      });

      /** Chart 1: **/
      // Calculate average score for each scenario
      function registerClassAverageChart() {
        const container = document.getElementById('chart-container');
        
        const newChartDiv = document.createElement('div');
        newChartDiv.className = 'card';
        newChartDiv.innerHTML = `
          <h2 class="chart-title text-gray-700">Class Average Score</h2>
          <canvas id="classAverageChart" width="400" height="200"></canvas>
        `;
        
        container.appendChild(newChartDiv);

        const ctx = newChartDiv.querySelector('#classAverageChart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: scenarioNames,
            datasets: [{
              label: 'Average Score',
              data: averageScores,
              backgroundColor: 'rgba(75, 192, 192, 0.6)',
              borderColor: 'rgba(75, 192, 192, 1)',
              borderWidth: 1,
              borderRadius: 8
            }]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
                max: 100
              }
            }
          }
        });
      }

      /** Chart 2: **/
      function registerCompletionTimeChart() {
        const container = document.getElementById('chart-container');
        
        const newChartDiv = document.createElement('div');
        newChartDiv.className = 'card';
        newChartDiv.innerHTML = `
          <h2 class="chart-title text-gray-700">Average Completion Time by Scenario</h2>
          <canvas id="completionTimeChart" width="400" height="200"></canvas>
        `;
        
        container.appendChild(newChartDiv);

        const averageCompletionTimes = scenarioNames.map((_, index) => {
          const totalTime = studentsData.reduce((sum, student) => sum + parseFloat(student.Data[index].Completion_Time), 0);
          return (totalTime / studentsData.length).toFixed(2); // Average completion time
        });

        const ctx = newChartDiv.querySelector('#completionTimeChart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: scenarioNames,
            datasets: [{
              label: 'Average Completion Time (Minutes)',
              data: averageCompletionTimes,
              backgroundColor: 'rgba(255, 159, 64, 0.2)',
              borderColor: 'rgba(255, 159, 64, 1)',
              borderWidth: 1,
              borderRadius: 8
            }]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
                max: 10 // Adjust depending on your time scale
              }
            }
          }
        });
      }

      /** Chart 3: **/
      const registerScoreDistributionChart = () => {
        const container = document.getElementById('chart-container');
        
        const newChartDiv = document.createElement('div');
        newChartDiv.className = 'card';
        newChartDiv.innerHTML = `
          <h2 class="chart-title text-gray-700">Score Distribution by Scenario</h2>
          <canvas id="scoreDistributionChart" width="400" height="200"></canvas>
        `;
        
        container.appendChild(newChartDiv);

        // Calculate score distribution for each scenario
        const scoreDistribution = scenarioNames.map((_, index) => {
            let above50 = 0, below50 = 0;
            studentsData.forEach(student => {
                const score = student.Data[index].Earned_Score;
                if (score >= 50) above50++;
                else below50++;
            });
            return { above50, below50 };
        });

        // Extract above and below 50 scores for stacked bar
        const scoresAbove50 = scoreDistribution.map(s => s.above50);
        const scoresBelow50 = scoreDistribution.map(s => s.below50);

        const ctx = newChartDiv.querySelector('#scoreDistributionChart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: scenarioNames,
            datasets: [{
              label: 'Scores ≥ 50',
              data: scoresAbove50,
              backgroundColor: 'rgba(54, 162, 235, 0.2)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1
            }, {
              label: 'Scores < 50',
              data: scoresBelow50,
              backgroundColor: 'rgba(255, 99, 132, 0.2)',
              borderColor: 'rgba(255, 99, 132, 1)',
              borderWidth: 1
            }]
          },
          options: {
            scales: {
              x: { stacked: true },
              y: { 
                stacked: true, 
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Number of Students'
                }
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return `${context.dataset.label}: ${context.raw} students`;
                  }
                }
              }
            }
          }
        });
      }

      /** Chart 4: **/
      function registerScoreDistributionHistogram() {
        const container = document.getElementById('chart-container');
        
        const newChartDiv = document.createElement('div');
        newChartDiv.className = 'card';
        newChartDiv.innerHTML = `
          <h2 class="chart-title text-gray-700">Score Distribution Histogram</h2>
          <canvas id="scoreDistributionHistogram" width="400" height="200"></canvas>
        `;
        
        container.appendChild(newChartDiv);

         // Score bins (0-10, 11-20, ..., 91-100) for score distribution
        const scoreHistogramBins = Array.from({ length: 10 }, (_, i) => `${i * 10}-${i * 10 + 9}`);

        // Calculate score distribution for the first scenario (index 0 used as an example)
        const scenarioScoreDistribution = Array(scoreHistogramBins.length).fill(0); // Initialize bin counts with 0
        studentsData.forEach(student => {
          const score = student.Data[0].Earned_Score; // First scenario score for each student
          const binIndex = Math.min(Math.floor(score / 10), scoreHistogramBins.length - 1); // Find bin
          scenarioScoreDistribution[binIndex]++;
        });

        const ctx = newChartDiv.querySelector('#scoreDistributionHistogram').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: scoreHistogramBins,
            datasets: [{
              label: 'Number of Students',
              data: scenarioScoreDistribution,
              backgroundColor: 'rgba(255, 205, 86, 0.2)',
              borderColor: 'rgba(255, 205, 86, 1)',
              borderWidth: 1,
              borderRadius: 8
            }]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Number of Students'
                }
              },
              x: {
                title: {
                  display: true,
                  text: 'Score Range'
                }
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return `${context.raw} students`;
                  }
                }
              }
            }
          }
        });
      }

      /** Chart 5: **/
      function registerPassFailRatioChart() {
        const container = document.getElementById('chart-container');
        
        const newChartDiv = document.createElement('div');
        newChartDiv.className = 'card';
        newChartDiv.innerHTML = `
          <h2 class="chart-title text-gray-700">Pass/Fail Ratio</h2>
          <canvas id="passFailRatioChart" width="400" height="200"></canvas>
        `;
        
        container.appendChild(newChartDiv);

        let totalPass = 0;
        let totalFail = 0;

        studentsData.forEach(student => {
          // Calculate the average score across all scenarios for this student
          const totalScore = student.Data.reduce((sum, scenario) => sum + scenario.Earned_Score, 0);
          const averageScore = totalScore / student.Data.length;

          // Determine if the student passed or failed based on average score
          if (averageScore >= 50) {
            totalPass++;
          } else {
            totalFail++;
          }
        });

        const ctx = newChartDiv.querySelector('#passFailRatioChart').getContext('2d');
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Pass (≥ 50)', 'Fail (< 50)'],
            datasets: [{
              label: 'Pass/Fail Ratio',
              data: [totalPass, totalFail],
              backgroundColor: ['rgba(75, 192, 192, 0.6)', 'rgba(255, 99, 132, 0.6)'],
              borderColor: ['rgba(75, 192, 192, 1)', 'rgba(255, 99, 132, 1)'],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                position: 'top',
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.raw || 0;
                    const total = context.dataset.data.reduce((acc, data) => acc + data, 0);
                    const percentage = ((value / total) * 100).toFixed(1);
                    return `${label}: ${value} students (${percentage}%)`;
                  }
                }
              }
            }
          }
        });
      }

      /** Chart 6: **/
      function registerImprovementSuggestionsChart() {
        const container = document.getElementById('chart-container');
        
        const newChartDiv = document.createElement('div');
        newChartDiv.className = 'card';
        newChartDiv.innerHTML = `
          <h2 class="chart-title text-gray-700">Improvement Suggestions (Lowest Average Scores)</h2>
          <canvas id="improvementSuggestionsRadarChart" width="400" height="200"></canvas>
        `;
        
        container.appendChild(newChartDiv);

        const sortedRadarScenarios = scenarioNames.map((name, index) => ({
          scenario: name,
          averageScore: averageScores[index]
        })).sort((a, b) => a.averageScore - b.averageScore);

        // Select the bottom 5 scenarios with the lowest average scores for the radar chart
        const lowestRadarScenarios = sortedRadarScenarios.slice(0, 5);
        const lowestRadarScenarioNames = lowestRadarScenarios.map(s => s.scenario);
        const lowestRadarScenarioScores = lowestRadarScenarios.map(s => s.averageScore);


        const ctx = newChartDiv.querySelector('#improvementSuggestionsRadarChart').getContext('2d');
        new Chart(ctx, {
          type: 'radar',
          data: {
            labels: lowestRadarScenarioNames,
            datasets: [{
              label: 'Average Score',
              data: lowestRadarScenarioScores,
              backgroundColor: 'rgba(255, 99, 132, 0.2)',
              borderColor: 'rgba(255, 99, 132, 1)',
              pointBackgroundColor: 'rgba(255, 99, 132, 1)',
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
              r: {
                angleLines: { display: true },
                suggestedMin: 0,
                suggestedMax: 100,
                ticks: {
                  stepSize: 20,
                  color: '#374151',
                  font: { size: 12 }
                }
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return `Average Score: ${context.raw.toFixed(2)}`;
                  }
                }
              },
              legend: {
                position: 'top'
              }
            }
          }
        });
      }

      /** Chart 7: **/
      function registerTopPerformingChart() {
        const container = document.getElementById('chart-container');
        
        const newChartDiv = document.createElement('div');
        newChartDiv.className = 'card';
        newChartDiv.innerHTML = `
          <h2 class="chart-title text-gray-700">Top Performing Scenarios (Highest Average Scores)</h2>
          <canvas id="topPerformingRadarChart" width="400" height="200"></canvas>
        `;
        
        container.appendChild(newChartDiv);

        // Sort scenarios by average score in descending order (for top performing)
        const topScenarios = scenarioNames.map((name, index) => ({
            scenario: name,
            averageScore: averageScores[index]
        })).sort((a, b) => b.averageScore - a.averageScore);

        // Top Performing Scenarios Radar Chart Data
        const topRadarScenarioNames = topScenarios.slice(0, 5).map(s => s.scenario);
        const topRadarScenarioScores = topScenarios.slice(0, 5).map(s => s.averageScore);

        const ctx = newChartDiv.querySelector('#topPerformingRadarChart').getContext('2d');
        new Chart(ctx, {
          type: 'radar',
          data: {
            labels: topRadarScenarioNames,
            datasets: [{
              label: 'Average Score',
              data: topRadarScenarioScores,
              backgroundColor: 'rgba(54, 162, 235, 0.2)',
              borderColor: 'rgba(54, 162, 235, 1)',
              pointBackgroundColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
              r: {
                angleLines: { display: true },
                suggestedMin: 0,
                suggestedMax: 100,
                ticks: {
                  stepSize: 20,
                  color: '#374151',
                  font: { size: 12 }
                }
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return `Average Score: ${context.raw.toFixed(2)}`;
                  }
                }
              },
              legend: {
                position: 'top'
              }
            }
          }
        });
      }

      /** Chart 8: **/
      function registerPerformanceTrendChart() {
        const container = document.getElementById('chart-container');
        
        const newChartDiv = document.createElement('div');
        newChartDiv.className = 'card';
        newChartDiv.innerHTML = `
          <h2 class="chart-title text-gray-700">Student Performance Trend Over Time</h2>
          <canvas id="performanceTrendChart" width="400" height="200"></canvas>
        `;
        
        container.appendChild(newChartDiv);

        // Generate mock data for performance trend
        const trendData = scenarioNames.map((scenario, index) => ({
          x: index + 1, // Order of scenarios as X-axis
          y: averageScores[index] // Average score for each scenario
        }));

        // Generate sample trend data for individual students (Optional)
        const studentTrendData = studentsData.map(student => ({
          label: student.Metadata.StudentID,
          data: student.Data.map((scenario, index) => ({
            x: index + 1,
            y: scenario.Earned_Score
          })),
          borderColor: 'rgba(54, 162, 235, 0.6)',
          fill: false,
          tension: 0.1
        }));

        const ctx = newChartDiv.querySelector('#performanceTrendChart').getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: scenarioNames,
            datasets: [{
              label: 'Class Average Performance',
              data: trendData,
              borderColor: 'rgba(255, 99, 132, 0.6)',
              fill: false,
              tension: 0.1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return `Scenario ${context.label}: Average Score = ${context.raw.y.toFixed(2)}`;
                  }
                }
              }
            },
            scales: {
              x: {
                title: {
                  display: true,
                  text: 'Scenario Number',
                  color: '#374151',
                  font: {
                    size: 14,
                    weight: 'bold'
                  }
                }
              },
              y: {
                beginAtZero: true,
                max: 100,
                title: {
                  display: true,
                  text: 'Average Score',
                  color: '#374151',
                  font: {
                    size: 14,
                    weight: 'bold'
                  }
                }
              }
            }
          }
        });
      }

      /** Chart 9: **/
      // Calculate the average score for each student
      function registerTopBottomPerformersTable() {
        const container = document.getElementById('chart-container');
        
        const newTableDiv = document.createElement('div');
        newTableDiv.className = 'card';
        newTableDiv.innerHTML = `
          <h2 class="chart-title text-gray-700">Top and Bottom Performers</h2>
          <table class="table-auto w-full text-left">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-2">Rank</th>
                <th class="px-4 py-2">Student</th>
                <th class="px-4 py-2">Average Score</th>
              </tr>
            </thead>
            <tbody id="topPerformers">
              <!-- Top Performers Section -->
            </tbody>
            <tbody id="bottomPerformers">
              <!-- Bottom Performers Section -->
            </tbody>
          </table>
        `;
        
        container.appendChild(newTableDiv);

        // Calculate the average score for each student
        const studentScores = studentsData.map(student => {
          const totalScore = student.Data.reduce((sum, scenario) => sum + scenario.Earned_Score, 0);
          const averageScore = totalScore / student.Data.length;
          return {
            studentId: student.Metadata.StudentID,
            averageScore: averageScore.toFixed(2)
          };
        });

        // Sort students by their average score
        studentScores.sort((a, b) => b.averageScore - a.averageScore);

        // Get top 3 and bottom 3 performers
        const topPerformers = studentScores.slice(0, 3);
        const bottomPerformers = studentScores.slice(-3);

        // Function to render table rows for performers
        function renderPerformers(performers, tableId, isTop = true) {
          const tbody = newTableDiv.querySelector(`#${tableId}`);
          tbody.innerHTML = '';
          performers.forEach((performer, index) => {
            const row = document.createElement('tr');
            row.classList.add(isTop ? 'bg-green-100' : 'bg-red-100');
            row.innerHTML = `
              <td class="border px-4 py-2 font-bold">${isTop ? index + 1 : studentsData.length - index}</td>
              <td class="border px-4 py-2">${performer.studentId}</td>
              <td class="border px-4 py-2">${performer.averageScore}</td>
            `;
            tbody.appendChild(row);
          });
        }

        // Render the top and bottom performers
        renderPerformers(topPerformers, 'topPerformers', true);
        renderPerformers(bottomPerformers, 'bottomPerformers', false);
      }

      /** Chart 10: **/
      function registerDifficultyImportanceChart() {
        const container = document.getElementById('chart-container');
        
        const newChartDiv = document.createElement('div');
        newChartDiv.className = 'card';
        newChartDiv.innerHTML = `
          <h2 class="chart-title text-gray-700">Scenario Difficulty vs. Importance</h2>
          <canvas id="difficultyImportanceChart" width="400" height="200"></canvas>
        `;
        
        container.appendChild(newChartDiv);
        const scenarioImportance = {
          "การเตรียมตัวผู้ทำคลอด 2/2": 8,
          "การเตรียมอุปกรณ์ทำคลอด": 7,
          "การเตรียมอุปกรณ์ทำคลอด 1. Sponge forceps": 6,
          "การเตรียมอุปกรณ์ทำคลอด 2. Episiotomy scissors": 6,
          "การเตรียมอุปกรณ์ทำคลอด 3. Cord Clamp": 6,
          "การเตรียมอุปกรณ์ทำคลอด 4. Artery Clamp": 6,
          "การเตรียมอุปกรณ์ทำคลอด 5. Umbilical scissors": 6,
          "การเตรียมตัวผู้คลอด 1/3": 9,
          "การเตรียมตัวผู้คลอด 1/3 โกรกน้ำผู้คลอดรอบที่ 1": 7,
          "การเตรียมตัวผู้คลอด 1/3 ทำ Scrub Vulva ถูกต้อง": 9,
          "การเตรียมตัวผู้คลอด 1/3 ทำ Scrub Vulva เสร็จทิ้งสำลีลงถังขยะ": 7,
          "การเตรียมตัวผู้คลอด 2/3 ใช้ Sponge forceps เสร็จให้หนีบที่ชายผ้า": 7,
          "การเตรียมตัวผู้คลอด 2/3 โกรกน้ำรอบ 2 เสร็จนำสำลีไปไว้อ่างเดิม": 7,
          "การเตรียมตัวผู้คลอด 2/3 ปูผ้าผู้คลอด ชิ้นที่ 1 รองใต้ก้น": 8,
          "การเตรียมตัวผู้คลอด 2/3 ปูผ้าผู้คลอด ชิ้นที่ 2 บนหน้าท้อง": 8,
          "การเตรียมตัวผู้คลอด 3/3 ปูผ้าผู้คลอด ชิ้นที่ 3 สวมขา ข้างใดก่อนก็ได้": 8,
          "การทำคลอดทารก 1/4 การตัดฝีเย็บ เฉียงไปทางขวาของผู้คลอด": 10,
          "การทำคลอดทารก 1/4 ทำ Safe perineum ไม่ให้ฝีเย็บฉีกเพิ่ม": 10,
          "การทำคลอดทารก 2/4 ดูดเสมหะให้ทารกทางปากและจมูก": 9,
          "การทำคลอดทารก 3/4 ทำการคลอดไหล่ล่างในท่าที่ถูกต้อง": 9,
          "การทำคลอดทารก 4/4 คลอดเสร็จดูดเสมหะทารก ปากและจมูก": 9,
          "การทำคลอดรก 1/2 นำถุงรองเลือดไปรองใต้ก้นผู้คลอด": 8,
          "การทำคลอดรก 1/2 ทำ Uterine sign เปิดผ้าบนหน้าท้อง": 8,
          "การทำคลอดรก 1/2 ทำ Cord sign และคลำชีพจรด้วยนิ้วชี้และนิ้วกลาง": 8,
          "การทำคลอดรก 1/2 ทำ Vulva sign ต้องรอจนกว่ําเลือดจะหยุดไหล": 9,
          "การทำคลอดรก 2/2 กดหน้าท้องต่อเนื่อง จนขั้วรกเริ่มออกมา": 9,
          "การทำคลอดรก 2/2 กดหน้าท้องต่อเนื่อง จนรกเคลื่อนออกมา": 9,
          "ผู้ช่วยฉีดยาเร่งคลอด ฉีดยาถูกต้อง เลือกปริมาณยาถูกต้อง (P30)": 7,
          "ผู้ช่วยฉีดยาเร่งคลอด ฉีดยาถูกต้อง เลือกปริมาณยาถูกต้อง (P31)": 7,
          "Scenario ที่ 1 มารดาครรภ์แรก อายุ 26 ปี อายุครรภ์ 40 สัปดาห์": 10,
          "Scenario ที่ 2 มารดา G2P1 อายุ 30 ปี อายุครรภ์ 39 สัปดาห์": 10
        };

        // Calculate the difficulty of each scenario (inverse of average score)
        const scenarioDifficulty = scenarioNames.map((scenario, index) => {
          const totalScore = studentsData.reduce((sum, student) => sum + student.Data[index].Earned_Score, 0);
          const averageScore = totalScore / studentsData.length;
          return {
            scenario: scenario,
            difficulty: 100 - averageScore, // Inverse of the average score
            importance: scenarioImportance[scenario] || 5 // Default importance if not defined
          };
        });

      // Prepare data for scatter plot
      const scatterData = {
        labels: scenarioDifficulty.map(s => s.scenario),
        datasets: [{
          label: 'Scenario Difficulty vs. Importance',
          data: scenarioDifficulty.map(s => ({
            x: s.importance,
            y: s.difficulty,
            scenario: s.scenario
          })),
          backgroundColor: 'rgba(54, 162, 235, 0.6)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1,
          pointRadius: 6
        }]
      };

        const ctx = newChartDiv.querySelector('#difficultyImportanceChart').getContext('2d');
        new Chart(ctx, {
          type: 'scatter',
          data: {
            datasets: [{
              label: 'Scenarios',
              data: scenarioDifficulty.map(s => ({
                x: s.importance,
                y: s.difficulty,
                scenario: s.scenario
              })),
              backgroundColor: 'rgba(54, 162, 235, 0.6)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1,
              pointRadius: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
              x: {
                type: 'linear',
                position: 'bottom',
                title: {
                  display: true,
                  text: 'Importance',
                  font: {
                    size: 14,
                    weight: 'bold'
                  }
                },
                min: 0,
                max: 10 // Assuming importance is rated from 1 to 10
              },
              y: {
                title: {
                  display: true,
                  text: 'Difficulty (Inverse of Average Score)',
                  font: {
                    size: 14,
                    weight: 'bold'
                  }
                },
                min: 0,
                max: 100 // Difficulty scale is from 0 to 100
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.raw.scenario || '';
                    return `Scenario: ${label}\nImportance: ${context.raw.x}\nDifficulty: ${context.raw.y.toFixed(2)}`;
                  }
                }
              }
            }
          }
        });
      }

      function registerMixedClassAverageChart() {
        const container = document.getElementById('chart-container');
        
        const newChartDiv = document.createElement('div');
        newChartDiv.className = 'card';
        newChartDiv.innerHTML = `
          <h2 class="chart-title text-gray-700">Class Average Score with Score Distribution</h2>
          <canvas id="classAverageChart" width="400" height="200"></canvas>
        `;
        
        container.append(newChartDiv);

        const scenarioNames = studentsData[0].Data.map(d => d.Scenario);
        const averageScores = scenarioNames.map((_, index) => {
          const totalScore = studentsData.reduce((sum, student) => sum + student.Data[index].Earned_Score, 0);
          return totalScore / studentsData.length;
        });

        // Calculate score distribution for each scenario
        const scoreDistribution = scenarioNames.map((_, index) => {
          let above50 = 0, below50 = 0;
          studentsData.forEach(student => {
            const score = student.Data[index].Earned_Score;
            if (score >= 50) above50++;
            else below50++;
          });
          return { above50, below50 };
        });

        // Extract above and below 50 scores for stacked bar
        const scoresAbove50 = scoreDistribution.map(s => s.above50);
        const scoresBelow50 = scoreDistribution.map(s => s.below50);

        // Chart.js configuration for Class Average Score with Distribution
        const ctx = document.getElementById('classAverageChart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: scenarioNames,
            datasets: [
              {
                label: 'Scores < 50',
                data: scoresBelow50,
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1,
                yAxisID: 'y'  // Left y-axis for student count
              },
              {
                label: 'Scores ≥ 50',
                data: scoresAbove50,
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1,
                yAxisID: 'y'  // Left y-axis for student count
              },
              {
                label: 'Average Score',
                data: averageScores,
                type: 'line',
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 2,
                fill: false,
                tension: 0.1,
                yAxisID: 'y1'  // Right y-axis for average score
              }
            ]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Number of Students'
                },
                stacked: true  // Stacked bar for student count
              },
              y1: {
                beginAtZero: true,
                max: 100,
                position: 'right',  // Right y-axis for average score
                title: {
                  display: true,
                  text: 'Average Score'
                }
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    if (context.dataset.type === 'line') {
                      return `Average Score: ${context.raw.toFixed(2)}`;
                    }
                    return `${context.dataset.label}: ${context.raw} students`;
                  }
                }
              }
            }
          }
        });
      }

      function registerScoreDistributionHistogram() {
        const container = document.getElementById('chart-container');

        const scoreHistogramBins = Array.from({ length: 10 }, (_, i) => `${i * 10}-${i * 10 + 9}`);
        const ctx = document.getElementById('scoreDistributionHistogramByScenarios').getContext('2d');

        // Generate checkboxes for each scenario dynamically
        const scenarioSelectionDiv = document.getElementById('scenario-selection');
        scenarioNames.forEach((scenario, index) => {
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = `scenario-checkbox-${index}`;
          checkbox.value = index;
          checkbox.checked = index === 0; // Default selection for the first scenario

          const label = document.createElement('label');
          label.htmlFor = checkbox.id;
          label.innerText = scenario;
          label.className = 'text-gray-600';

          const div = document.createElement('div');
          div.className = 'flex items-center space-x-2';
          div.appendChild(checkbox);
          div.appendChild(label);
          scenarioSelectionDiv.appendChild(div);

          checkbox.addEventListener('change', updateChart);
        });

        // Function to calculate score distributions for selected scenarios
        function calculateScoreDistribution(selectedScenarios) {
          const scoreDistributionData = [];

          selectedScenarios.forEach((scenarioIndex) => {
            const scenarioScoreDistribution = Array(scoreHistogramBins.length).fill(0); // Initialize bin counts with 0
            studentsData.forEach((student) => {
              const score = student.Data[scenarioIndex].Earned_Score;
              const binIndex = Math.min(Math.floor(score / 10), scoreHistogramBins.length - 1); // Find bin
              scenarioScoreDistribution[binIndex]++;
            });
            scoreDistributionData.push(scenarioScoreDistribution);
          });

          return scoreDistributionData;
        }

        // Update chart when user selects/deselects scenarios
        function updateChart() {
          const selectedScenarioIndexes = Array.from(scenarioSelectionDiv.querySelectorAll('input[type="checkbox"]:checked')).map(
            (checkbox) => parseInt(checkbox.value)
          );

          const scoreDistributionData = calculateScoreDistribution(selectedScenarioIndexes);

          // Remove old datasets and add new ones
          histogramChart.data.datasets = [];
          selectedScenarioIndexes.forEach((scenarioIndex, i) => {
            histogramChart.data.datasets.push({
              label: scenarioNames[scenarioIndex],
              data: scoreDistributionData[i],
              backgroundColor: `rgba(${54 + i * 50}, 162, ${235 - i * 50}, 0.2)`,
              borderColor: `rgba(${54 + i * 50}, 162, ${235 - i * 50}, 1)`,
              borderWidth: 1,
            });
          });

          histogramChart.update();
        }

        // Initial chart setup
        const histogramChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: scoreHistogramBins,
            datasets: [],
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Number of Students',
                },
              },
              x: {
                title: {
                  display: true,
                  text: 'Score Range',
                },
              },
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function (context) {
                    return `${context.dataset.label}: ${context.raw} students`;
                  },
                },
              },
            },
          },
        });

        // Trigger the initial chart rendering
        updateChart();
      }
      
      // registerClassAverageChart();
      registerCompletionTimeChart();
      registerScoreDistributionChart();
      registerScoreDistributionHistogram();
      registerPassFailRatioChart();
      registerImprovementSuggestionsChart();
      registerTopPerformingChart();
      registerPerformanceTrendChart();
      registerTopBottomPerformersTable();
      registerDifficultyImportanceChart();
      
      registerMixedClassAverageChart();
    </script>
</body>
</html>